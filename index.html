<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>rcrly LFE API Reference</title>

    <link href="css/screen.css" rel="stylesheet" type="text/css" media="screen" />
    <link href="css/print.css" rel="stylesheet" type="text/css" media="print" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
      <script src="js/all.js" type="text/javascript"></script>

      <script>
        $(function() {
          setupLanguages([null]);
        });
      </script>
  </head>

  <body class="index">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" />
      </span>
    </a>
    <div class="tocify-wrapper">
      <img src="images/logo.png" />
        <div class="lang-selector">
              <a href="#" data-language-name=""></a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <div id="toc">
      </div>
        <ul class="toc-footer">
            <li><a href='http://githug.com/cinova/rcrly/'>View the source</a></li>
            <li><a href='http://github.com/tripit/slate'>Documentation Powered by Slate</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        
          <h1 id="introduction">Introduction</h1>

<p><em>An Erlang/LFE Client for the Recurly Billing REST API</em></p>

<p><img src="images/recurly-logo-small.png" /></p>

<p>From the Recurly <a href="https://docs.recurly.com/">docs site</a>:</p>

<p>&ldquo;Recurly provides a complete recurring billing system designed to remove all the headaches from subscription billing. Whether youâ€™ve integrated with our Hosted Payment Pages, Recurly.js embedded forms, or API, these documents will help manage your day-to-day billing.&rdquo;</p>

<p>The LFE library for the Recurly REST service was created in order to support the billing needs of LFE, Erlang, and other BEAM language applications that need to offer billing features.</p>

<aside class="warning">
Note that this library has not implemented <em>all</em> of the Recurly API, just the most commonly-used functions.
</aside>

<aside class="success">
If your favourite API call is missing, <a href="https://github.com/cinova/rcrly/issues/new">let us know</a> or send along a PR with your implementation of it!
</aside>

          <h1 id="getting-started">Getting Started</h1>

<h2 id="installation">Installation</h2>

<blockquote>
<p>Just add the rcrly repo to your <code class="prettyprint">rebar.config</code> deps:</p>
</blockquote>
<pre class="highlight erlang"><code>  <span class="p">{</span><span class="n">deps</span><span class="p">,</span> <span class="p">[</span>
    <span class="p">...</span>
    <span class="p">{</span><span class="n">rcrly</span><span class="p">,</span> <span class="s">".*"</span><span class="p">,</span>
      <span class="p">{</span><span class="n">git</span><span class="p">,</span> <span class="s">"git@github.com:cinova/rcrly.git"</span><span class="p">,</span> <span class="s">"master"</span><span class="p">}}</span>
      <span class="p">]}.</span>
</code></pre>

<blockquote>
<p>Or, if you use <code class="prettyprint">lfe.config</code>:</p>
</blockquote>
<pre class="highlight common_lisp"><code>    <span class="o">#(</span><span class="nv">project</span> <span class="p">(</span><span class="o">#(</span><span class="nv">deps</span> <span class="p">(</span><span class="o">#(</span><span class="s">"cinova/rcrly"</span> <span class="s">"master"</span><span class="p">)))))</span>
</code></pre>

<blockquote>
<p>And then do the usual:</p>
</blockquote>
<pre class="highlight shell"><code>    <span class="nv">$ </span>make compile
</code></pre>

<p>To install the LFE rcrly REST client library, follow the standard rebar practics or use an <code class="prettyprint">lfe.config</code> file.</p>

<h2 id="configuration">Configuration</h2>

<blockquote>
<p>This project comes with a sample configuration file you can copy and then edit:</p>
</blockquote>
<pre class="highlight shell"><code><span class="gp">$ </span>cp sample-lfe.ini ~/.rcrly/lfe.ini
</code></pre>

<blockquote>
<p>Or you can just use the following as a template:</p>
</blockquote>
<pre class="highlight ini"><code><span class="nn">[REST API]</span>
<span class="py">key</span> <span class="p">=</span> <span class="s">GFEDCBA9876543210</span>
<span class="py">host</span> <span class="p">=</span> <span class="s">yourname.recurly.com</span>
<span class="py">timeout</span> <span class="p">=</span> <span class="s">10000</span>
<span class="py">version</span> <span class="p">=</span> <span class="s">v2</span>
</code></pre>

<p>The LFE rcrly library supports two modes of configuration:</p>

<ul>
<li>OS environment variables</li>
<li>the use of <code class="prettyprint">~/.rcrly/lfe.ini</code></li>
</ul>

<p>OS environment variables take precedence over values in the configuration file.
If you would like to use environment variables, the following may be set:</p>

<ul>
<li><code class="prettyprint">RECURLY_API_KEY</code></li>
<li><code class="prettyprint">RECURLY_HOST</code> (e.g., <code class="prettyprint">yourname.recurly.com</code>)</li>
<li><code class="prettyprint">RECURLY_DEFAULT_CURRENCY</code></li>
<li><code class="prettyprint">RECURLY_VERSION</code></li>
<li><code class="prettyprint">RECURLY_REQUEST_TIMEOUT</code></li>
</ul>

<p>You have the option of using values stored in a configuration file, instead.</p>

<aside class="warning">
If neither of these methods is used to set a given variable, the default which
is hard-coded in <code>src/rcrly-cfg.lfe</code> will be used &ndash; and in the case of the
API key or host this is almost certainly not what you want!
</aside>

<h2 id="starting-rcrly">Starting <code class="prettyprint">rcrly</code></h2>

<blockquote>
<p>Execute the following before using rcrly, when not using the <code class="prettyprint">make</code> targets which start it automatically:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:start</span><span class="p">)</span>
<span class="p">(</span><span class="o">#(</span><span class="nv">gproc</span> <span class="nv">ok</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">econfig</span> <span class="nv">ok</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">inets</span> <span class="nv">ok</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">ssl</span> <span class="nv">ok</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">lhttpc</span> <span class="nv">ok</span><span class="p">))</span>
</code></pre>

<p>The <code class="prettyprint">make</code> targets for both the LFE REPL and the Erlang shell start rcrly
automatically. If you didn&rsquo;t use either of those, then you will need to
start rcrly manually.</p>

<p>If you&rsquo;re not in the REPL and you will be using this library programmatically,
you will want to make that call when your own application starts.</p>

<h2 id="authentication">Authentication</h2>

<blockquote>
<p>In your OS shell, export your Recurly API key and your subdomain, e.g.:</p>
</blockquote>
<pre class="highlight shell"><code><span class="gp">$ </span><span class="nb">export </span><span class="nv">RECURLY_API_KEY</span><span class="o">=</span>GFEDCBA9876543210
<span class="gp">$ </span><span class="nb">export </span><span class="nv">RECURLY_HOST</span><span class="o">=</span>yourname.recurly.com
</code></pre>

<blockquote>
<p>Or be sure to have these defined in your <code class="prettyprint">~/.rcrly/lfe.ini</code> file:</p>
</blockquote>
<pre class="highlight ini"><code><span class="nn">[REST API]</span>
<span class="py">key</span> <span class="p">=</span> <span class="s">GFEDCBA9876543210</span>
<span class="py">host</span> <span class="p">=</span> <span class="s">yourname.recurly.com</span>
</code></pre>

<p>Recurly clients authenticate by setting HTTP headers. The rcrly library does this for you
automatically by extracting the necessary data from OS environment variables or from
your rcrly configuration file.</p>

<h2 id="making-calls">Making Calls</h2>

<blockquote>
<p>Making calls from LFE are pretty standard:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get-accounts</span><span class="p">)</span>
</code></pre>

<blockquote>
<p>Which gives results like the following:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="o">#(</span><span class="nv">ok</span>
  <span class="p">(</span><span class="o">#(</span><span class="nv">account</span> <span class="o">...</span><span class="p">)</span>
   <span class="o">#(</span><span class="nv">account</span> <span class="o">...</span><span class="p">)</span>
   <span class="o">...</span><span class="p">))</span>
</code></pre>

<blockquote>
<p>Erlang calls are done in the usual way, escaping hypenated LFE atoms as necessary:</p>
</blockquote>
<pre class="highlight erlang"><code><span class="mi">1</span><span class="o">&gt;</span> <span class="nn">rcrly</span><span class="p">:</span><span class="nf">'get-accounts'</span><span class="p">().</span>
</code></pre>

<blockquote>
<p>Which will give results in the following form:</p>
</blockquote>
<pre class="highlight erlang"><code><span class="p">{</span><span class="n">ok</span><span class="p">,[{</span><span class="n">account</span><span class="p">,</span> <span class="p">[...]},</span>
     <span class="p">{</span><span class="n">account</span><span class="p">,</span> <span class="p">[...]},</span>
     <span class="p">...]}</span>
</code></pre>

<p>As aluded to above, even though rcrly is written in LFE, it can be used from an BEAM
language which supports Core Erlang.</p>

<h2 id="options">Options</h2>

<p>Every rcrly <code class="prettyprint">get</code> and <code class="prettyprint">post</code> API call takes an optional final positional argument which supprts
keyword arguments. The following are supported (or planned) such options:</p>

<ul>
<li><code class="prettyprint">return-type</code> - what format the client calls should take. Can be one of
<code class="prettyprint">data</code>, <code class="prettyprint">full</code>, or <code class="prettyprint">xml</code>; the default  is <code class="prettyprint">data</code>.</li>
<li><code class="prettyprint">log-level</code> - sets the log level on-the-fly, for easy debugging on a
per-request basis</li>
<li><code class="prettyprint">endpoint</code> - whether the request being made is against an API endpoint
or a raw URL (defaults to <code class="prettyprint">true</code>)</li>
<li><code class="prettyprint">batch-size</code> - [NOT YET SUPPORTED] an integer between <code class="prettyprint">1</code> and <code class="prettyprint">200</code>
representing the number of results returned in the Recurly service responses;
defaults to <code class="prettyprint">20</code>.</li>
<li><code class="prettyprint">follow-links</code> - [NOT YET SUPPORTED] a boolean representing whether linked
data should be automatically quereied and added to the results; defaults to
<code class="prettyprint">false</code>.</li>
</ul>

<h2 id="return-type"><code class="prettyprint">return-type</code></h2>

<blockquote>
<p>When the <code class="prettyprint">return-type</code> is set to <code class="prettyprint">data</code> (the default), the data from the
response is what is returned:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get-account</span> <span class="mi">1</span> <span class="o">'</span><span class="p">(</span><span class="o">#(</span><span class="nv">return-type</span> <span class="nv">data</span><span class="p">)))</span>
</code></pre>

<blockquote>
<p>Results:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="o">#(</span><span class="nv">ok</span>
  <span class="p">(</span><span class="o">#(</span><span class="nv">adjustments</span> <span class="o">...</span><span class="p">)</span>
   <span class="o">#(</span><span class="nv">invoices</span> <span class="o">...</span><span class="p">)</span>
   <span class="o">#(</span><span class="nv">subscriptions</span> <span class="o">...</span><span class="p">)</span>
   <span class="o">#(</span><span class="nv">transactions</span> <span class="o">...</span><span class="p">)</span>
   <span class="o">#(</span><span class="nv">account_code</span> <span class="p">()</span> <span class="p">(</span><span class="s">"1"</span><span class="p">))</span>
   <span class="o">...</span>
   <span class="o">#(</span><span class="nv">address</span> <span class="o">...</span><span class="p">)</span>
   <span class="o">...</span><span class="p">))</span>
</code></pre>

<blockquote>
<p>When the <code class="prettyprint">return-type</code> is set to <code class="prettyprint">full</code>, the response is annotated and
returned:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get-account</span> <span class="mi">1</span> <span class="o">'</span><span class="p">(</span><span class="o">#(</span><span class="nv">return-type</span> <span class="nv">full</span><span class="p">)))</span>
</code></pre>

<blockquote>
<p>Results:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="o">#(</span><span class="nv">ok</span>
  <span class="p">(</span><span class="o">#(</span><span class="nv">response</span> <span class="nv">ok</span><span class="p">)</span>
   <span class="o">#(</span><span class="nv">status</span> <span class="o">#(</span><span class="mi">200</span> <span class="s">"OK"</span><span class="p">))</span>
   <span class="o">#(</span><span class="nv">headers</span> <span class="o">...</span><span class="p">)</span>
   <span class="o">#(</span><span class="nv">body</span>
     <span class="p">(</span><span class="o">#(</span><span class="nv">tag</span> <span class="s">"account"</span><span class="p">)</span>
      <span class="o">#(</span><span class="nv">attr</span> <span class="p">(</span><span class="o">#(</span><span class="nv">href</span> <span class="s">"https://yourname.recurly.com/v2/accounts/1"</span><span class="p">)))</span>
      <span class="o">#(</span><span class="nv">content</span>
        <span class="o">#(</span><span class="nv">account</span>
          <span class="p">(</span><span class="o">#(</span><span class="nv">adjustments</span> <span class="o">...</span><span class="p">)</span>
           <span class="o">#(</span><span class="nv">invoices</span> <span class="o">...</span><span class="p">)</span>
           <span class="o">#(</span><span class="nv">subscriptions</span> <span class="o">...</span><span class="p">)</span>
           <span class="o">#(</span><span class="nv">transactions</span> <span class="o">...</span><span class="p">)</span>
           <span class="o">...</span>
           <span class="o">#(</span><span class="nv">account_code</span> <span class="p">()</span> <span class="p">(</span><span class="s">"1"</span><span class="p">))</span>
           <span class="o">...</span>
           <span class="o">#(</span><span class="nv">address</span> <span class="o">...</span><span class="p">)</span>
           <span class="o">...</span><span class="p">)))</span>
      <span class="o">#(</span><span class="nv">tail</span> <span class="s">"\n"</span><span class="p">)))))</span>
</code></pre>

<blockquote>
<p>When the <code class="prettyprint">return-type</code> is set to <code class="prettyprint">xml</code>, the &ldquo;raw&rdquo; binary value is returned,
as it is obtained from <code class="prettyprint">lhttpc</code>, without modification or any parsing:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get-account</span> <span class="mi">1</span> <span class="o">'</span><span class="p">(</span><span class="o">#(</span><span class="nv">return-type</span> <span class="nv">xml</span><span class="p">)))</span>
</code></pre>

<blockquote>
<p>Results:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="o">#(</span><span class="nv">ok</span>
  <span class="o">#(#(</span><span class="mi">200</span> <span class="s">"OK"</span><span class="p">)</span>
    <span class="p">(</span><span class="o">#(</span><span class="s">"strict-transport-security"</span> <span class="s">"max-age=15768000; includeSubDomains"</span><span class="p">)</span>
     <span class="o">#(</span><span class="s">"x-request-id"</span> <span class="s">"ac52s06cmfugp9oauclg"</span><span class="p">)</span>
     <span class="o">#(</span><span class="s">"cache-control"</span> <span class="s">"max-age=0, private, must-revalidate"</span><span class="p">)</span>
     <span class="o">...</span><span class="p">)</span>
    <span class="err">#</span><span class="nv">B</span><span class="p">(</span><span class="mi">60</span> <span class="mi">63</span> <span class="mi">120</span> <span class="mi">109</span> <span class="mi">108</span> <span class="mi">32</span> <span class="mi">118</span> <span class="mi">101</span> <span class="mi">114</span> <span class="mi">115</span> <span class="mi">105</span> <span class="mi">111</span> <span class="mi">110</span>  <span class="o">...</span><span class="p">)))</span>
</code></pre>

<p>The rcrly client library lets you specify the format of the returned results by setting the value of the <code class="prettyprint">return-type</code> option.</p>

<h2 id="log-level"><code class="prettyprint">log-level</code></h2>

<blockquote>
<p>Set a new log level:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get-account</span> <span class="mi">1</span> <span class="o">'</span><span class="p">(</span><span class="o">#(</span><span class="nv">log-level</span> <span class="nv">debug</span><span class="p">)))</span>
</code></pre>

<p>At any point you may change the log level for the client.</p>

<h2 id="endpoint"><code class="prettyprint">endpoint</code></h2>

<blockquote>
<p>Normal &ldquo;endpoint&rdquo; call:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get</span> <span class="s">"/some/recurly/endpoint"</span><span class="p">)</span>
</code></pre>

<blockquote>
<p>Set the <code class="prettyprint">endpoint</code> option to <code class="prettyprint">false</code> to make a direct, &ldquo;URL&rdquo; call:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="nv">options</span> <span class="o">'</span><span class="p">(</span><span class="o">#(</span><span class="nv">endpoint</span> <span class="nv">false</span><span class="p">)))</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get</span> <span class="s">"https://some.domain/path/to/resource"</span> <span class="nv">options</span><span class="p">)</span>
</code></pre>

<p>If you wish to make a request to a full URL, you will need to pass the option
<code class="prettyprint">#(endpoint false)</code> to override the default behaviour of the rcrly library
creating the URL for you, based upon the provided endpoint.</p>

<h2 id="batch-size"><code class="prettyprint">batch-size</code></h2>

<p>TBD</p>

<h2 id="follow-links"><code class="prettyprint">follow-links</code></h2>

<p>TBD</p>

<h2 id="options-for-lhttpc">Options for lhttpc</h2>

<p>If you wish to pass general HTTP client options to lhttpc, then you will need to use
<code class="prettyprint">rcrly-httpc:request/7</code>, which takes the arguments <code class="prettyprint">endpoint</code>, <code class="prettyprint">method</code>,
<code class="prettyprint">headers</code>, <code class="prettyprint">body</code>, <code class="prettyprint">timeout</code>, <code class="prettyprint">options</code>, and <code class="prettyprint">lhttpc-options</code>.</p>

<p>The <code class="prettyprint">options</code> parameter is for the rcrly options discussed above, and <code class="prettyprint">lhttpc-options</code>
are the regular lhttpc options, the most significant of which are:</p>

<ul>
<li><code class="prettyprint">connect_options</code> - a list of terms</li>
<li><code class="prettyprint">send_retry</code> - an integer</li>
<li><code class="prettyprint">partial_upload</code> - an integer (window size)</li>
<li><code class="prettyprint">partial_download</code> - a list of one or both of <code class="prettyprint">#(window_size N)</code> and <code class="prettyprint">#(part_size N)</code></li>
<li><code class="prettyprint">proxy</code> - a URL string</li>
<li><code class="prettyprint">proxy_ssl_options</code> - a list of terms</li>
<li><code class="prettyprint">pool</code> - pid or atom</li>
</ul>

<h2 id="creating-payloads">Creating Payloads</h2>

<blockquote>
<p>To demonstrate creating XML, <code class="prettyprint">slurp</code> the following file:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">slurp</span> <span class="s">"src/rcrly-xml.lfe"</span><span class="p">)</span>
<span class="o">#(</span><span class="nv">ok</span> <span class="nv">rcrly-xml</span><span class="p">)</span>
</code></pre>

<blockquote>
<p>Now you can use the rcrly macros to create XML in LFE syntax:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">xml/account</span> <span class="p">(</span><span class="nv">xml/company_name</span> <span class="s">"Bob's Red Mill"</span><span class="p">))</span>
<span class="s">"&lt;account&gt;&lt;company_name&gt;Bob's Red Mill&lt;/company_name&gt;&lt;/account&gt;"</span>
</code></pre>

<blockquote>
<p>This also works for modules that will be genereating XML payloads: simply
<code class="prettyprint">include-lib</code> them like they are in <code class="prettyprint">rcrly-xml</code>:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="p">(</span><span class="nv">include-lib</span> <span class="s">"rcrly/include/xml.lfe"</span><span class="p">)</span>
</code></pre>

<blockquote>
<p>Here&rsquo;s a sample payload from the
<a href="https://docs.recurly.com/api/billing-info#update-billing-info-credit-card">Recurly docs</a>
(note that multiple children need to be wrapped in a <code class="prettyprint">list</code>):</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">xml/billing_info</span>
    <span class="p">(</span><span class="nb">list</span> <span class="p">(</span><span class="nv">xml/first_name</span> <span class="s">"Verena"</span><span class="p">)</span>
          <span class="p">(</span><span class="nv">xml/last_name</span> <span class="s">"Example"</span><span class="p">)</span>
          <span class="p">(</span><span class="nv">xml/number</span> <span class="s">"4111-1111-1111-1111"</span><span class="p">)</span>
          <span class="p">(</span><span class="nv">xml/verification_value</span> <span class="s">"123"</span><span class="p">)</span>
          <span class="p">(</span><span class="nv">xml/month</span> <span class="s">"11"</span><span class="p">)</span>
          <span class="p">(</span><span class="nv">xml/year</span> <span class="s">"2015"</span><span class="p">)))</span>
</code></pre>

<blockquote>
<p>Which produces the following result:</p>
</blockquote>
<pre class="highlight xml"><code>"<span class="nt">&lt;billing_info&gt;</span>
  <span class="nt">&lt;first_name&gt;</span>Verena<span class="nt">&lt;/first_name&gt;</span>
  <span class="nt">&lt;last_name&gt;</span>Example<span class="nt">&lt;/last_name&gt;</span>
  <span class="nt">&lt;number&gt;</span>4111-1111-1111-1111<span class="nt">&lt;/number&gt;</span>
  <span class="nt">&lt;verification_value&gt;</span>123<span class="nt">&lt;/verification_value&gt;</span>
  <span class="nt">&lt;month&gt;</span>11<span class="nt">&lt;/month&gt;</span>
  <span class="nt">&lt;year&gt;</span>2015<span class="nt">&lt;/year&gt;</span>
<span class="nt">&lt;/billing_info&gt;</span>"
</code></pre>

<p>Payloads for <code class="prettyprint">PUT</code> and <code class="prettyprint">POST</code> data in the Recurly REST API are XML
documents. As such, we need to be able to create XML for such things as
update actions. To facilitate this, The LFE rcrly library provides
XML-generating macros. in the REPL, you can <code class="prettyprint">slurp</code> the <code class="prettyprint">rcrly-xml</code>
module, and then have access to them. For instance:</p>

          <h1 id="working-with-results">Working with Results</h1>

<blockquote>
<p>Example form for multi-valued results:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="o">#(</span><span class="nv">ok</span>
  <span class="o">#(</span><span class="nv">accounts</span>
    <span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="c1">; attributes</span>
    <span class="p">(</span><span class="o">#(</span><span class="nv">account</span>
        <span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="c1">; attributes</span>
        <span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="c1">; child elements</span>
        <span class="p">)</span>
     <span class="o">#(</span><span class="nv">account</span> <span class="o">...</span><span class="p">)</span>
     <span class="o">#(</span><span class="nv">account</span> <span class="o">...</span><span class="p">)</span>
     <span class="o">...</span><span class="p">)))</span>
</code></pre>

<blockquote>
<p>Example form for single-valued results:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="o">#(</span><span class="nv">ok</span>
  <span class="o">#(</span><span class="nv">account</span>
    <span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="c1">; attributes</span>
    <span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="c1">; child elements</span>
    <span class="p">))</span>
</code></pre>

<p>All results in rcrly are of the form <code class="prettyprint">#(ok ...)</code> or <code class="prettyprint">#(error ...)</code>, with the
elided contents of those tuples changing depending upon context. This is the
standard approach for Erlang libraries, so should be quite familiar to users.</p>

<p>Recurly&rsquo;s API is XML-based; the rcrly API inherits some of its characteristics
from this fact. In particular, data structures representing the parsed XML data
are regularly returned by rcrly calls. Parsed rcrly results have the following:</p>

<ul>
<li>a tag</li>
<li>attributes</li>
<li>contents (which may itself contain nested tag/attrs/contents)</li>
</ul>

<p>As such, many results are often 3-tuples. rcrly includes functions (see below)
for working with this 3-tuple data.</p>

<p>The rcrly LFE library distinguishes between two different result types:</p>

<ul>
<li>multi-valued</li>
<li>single-valued</li>
</ul>

<p>Multi-valued results are simply results that have items in a lis. Many rcrly API
calls will return a list of items, for example, <code class="prettyprint">get-all-invoices/0</code>,
<code class="prettyprint">get-plans/0</code>, or <code class="prettyprint">get-accounts/0</code>. The rcrly library provides <code class="prettyprint">map</code> and
<code class="prettyprint">foldl</code> functions for easily working with these results.</p>

<p>By single-value results, we mean API calls which <em>do not</em> return a list of
values, but intstead return a single-item data structure. Examples of API calls
which do this are <code class="prettyprint">get-account/1</code>, <code class="prettyprint">get-billing-info/1</code>, <code class="prettyprint">get-plan/1</code>,
etc. The rcrly library provides functions like <code class="prettyprint">get-in</code> and <code class="prettyprint">get-linked</code> for
easily working with these results.</p>

<h2 id="format">Format</h2>

<blockquote>
<p>A standard Recurly XML result:</p>
</blockquote>
<pre class="highlight xml"><code><span class="nt">&lt;account</span> <span class="na">href=</span><span class="s">"https://yourname.recurly.com/v2/accounts/1"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;adjustments</span> <span class="na">href=</span><span class="s">"https://yourname.recurly.com/v2/accounts/1/adjustments"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;billing_info</span> <span class="na">href=</span><span class="s">"https://yourname.recurly.com/v2/accounts/1/billing_info"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;invoices</span> <span class="na">href=</span><span class="s">"https://yourname.recurly.com/v2/accounts/1/invoices"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;redemption</span> <span class="na">href=</span><span class="s">"https://yourname.recurly.com/v2/accounts/1/redemption"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;subscriptions</span> <span class="na">href=</span><span class="s">"https://yourname.recurly.com/v2/accounts/1/subscriptions"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;transactions</span> <span class="na">href=</span><span class="s">"https://yourname.recurly.com/v2/accounts/1/transactions"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;account_code&gt;</span>1<span class="nt">&lt;/account_code&gt;</span>
  <span class="nt">&lt;state&gt;</span>active<span class="nt">&lt;/state&gt;</span>
  <span class="nt">&lt;username</span> <span class="na">nil=</span><span class="s">"nil"</span><span class="nt">&gt;&lt;/username&gt;</span>
  <span class="nt">&lt;email&gt;</span>verena@example.com<span class="nt">&lt;/email&gt;</span>
  <span class="nt">&lt;first_name&gt;</span>Verena<span class="nt">&lt;/first_name&gt;</span>
  <span class="nt">&lt;last_name&gt;</span>Example<span class="nt">&lt;/last_name&gt;</span>
  <span class="nt">&lt;company_name&gt;&lt;/company_name&gt;</span>
  <span class="nt">&lt;vat_number</span> <span class="na">nil=</span><span class="s">"nil"</span><span class="nt">&gt;&lt;/vat_number&gt;</span>
  <span class="nt">&lt;tax_exempt</span> <span class="na">type=</span><span class="s">"boolean"</span><span class="nt">&gt;</span>false<span class="nt">&lt;/tax_exempt&gt;</span>
  <span class="nt">&lt;address&gt;</span>
    <span class="nt">&lt;address1&gt;</span>108 Main St.<span class="nt">&lt;/address1&gt;</span>
    <span class="nt">&lt;address2&gt;</span>Apt #3<span class="nt">&lt;/address2&gt;</span>
    <span class="nt">&lt;city&gt;</span>Fairville<span class="nt">&lt;/city&gt;</span>
    <span class="nt">&lt;state&gt;</span>WI<span class="nt">&lt;/state&gt;</span>
    <span class="nt">&lt;zip&gt;</span>12345<span class="nt">&lt;/zip&gt;</span>
    <span class="nt">&lt;country&gt;</span>US<span class="nt">&lt;/country&gt;</span>
    <span class="nt">&lt;phone</span> <span class="na">nil=</span><span class="s">"nil"</span><span class="nt">&gt;&lt;/phone&gt;</span>
  <span class="nt">&lt;/address&gt;</span>
  <span class="nt">&lt;accept_language</span> <span class="na">nil=</span><span class="s">"nil"</span><span class="nt">&gt;&lt;/accept_language&gt;</span>
  <span class="nt">&lt;hosted_login_token&gt;</span>a92468579e9c4231a6c0031c4716c01d<span class="nt">&lt;/hosted_login_token&gt;</span>
  <span class="nt">&lt;created_at</span> <span class="na">type=</span><span class="s">"datetime"</span><span class="nt">&gt;</span>2011-10-25T12:00:00<span class="nt">&lt;/created_at&gt;</span>
<span class="nt">&lt;/account&gt;</span>
</code></pre>

<blockquote>
<p>Here is that same result as parsed by the LFE rcrly library:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="o">#(</span><span class="nv">account</span>
  <span class="p">(</span><span class="o">#(</span><span class="nv">href</span> <span class="s">"https://yourname.recurly.com/v2/accounts/1"</span><span class="p">))</span>
  <span class="p">(</span><span class="o">#(</span><span class="nv">adjustments</span>
     <span class="p">(</span><span class="o">#(</span><span class="nv">href</span> <span class="s">"https://yourname.recurly.com/v2/accounts/1/adjustments"</span><span class="p">))</span>
     <span class="p">())</span>
   <span class="o">#(</span><span class="nv">invoices</span>
     <span class="p">(</span><span class="o">#(</span><span class="nv">href</span> <span class="s">"https://yourname.recurly.com/v2/accounts/1/invoices"</span><span class="p">))</span>
     <span class="p">())</span>
   <span class="o">#(</span><span class="nv">subscriptions</span>
     <span class="p">(</span><span class="o">#(</span><span class="nv">href</span> <span class="s">"https://yourname.recurly.com/v2/accounts/1/subscriptions"</span><span class="p">))</span>
     <span class="p">())</span>
   <span class="o">#(</span><span class="nv">transactions</span>
     <span class="p">(</span><span class="o">#(</span><span class="nv">href</span> <span class="s">"https://yourname.recurly.com/v2/accounts/1/transactions"</span><span class="p">))</span>
     <span class="p">())</span>
   <span class="o">#(</span><span class="nv">account_code</span> <span class="p">()</span> <span class="p">(</span><span class="s">"1"</span><span class="p">))</span>
   <span class="o">#(</span><span class="nv">state</span> <span class="p">()</span> <span class="p">(</span><span class="s">"active"</span><span class="p">))</span>
   <span class="o">#(</span><span class="nv">username</span> <span class="p">()</span> <span class="p">())</span>
   <span class="o">#(</span><span class="nv">email</span> <span class="p">()</span> <span class="p">(</span><span class="s">"verena@example.com"</span><span class="p">))</span>
   <span class="o">#(</span><span class="nv">first_name</span> <span class="p">()</span> <span class="p">(</span><span class="s">"Verena"</span><span class="p">))</span>
   <span class="o">#(</span><span class="nv">last_name</span> <span class="p">()</span> <span class="p">(</span><span class="s">"Example"</span><span class="p">))</span>
   <span class="o">#(</span><span class="nv">company_name</span> <span class="p">()</span> <span class="p">())</span>
   <span class="o">#(</span><span class="nv">vat_number</span> <span class="p">(</span><span class="o">#(</span><span class="no">nil</span> <span class="s">"nil"</span><span class="p">))</span> <span class="p">())</span>
   <span class="o">#(</span><span class="nv">tax_exempt</span> <span class="p">(</span><span class="o">#(</span><span class="k">type</span> <span class="s">"boolean"</span><span class="p">))</span> <span class="p">(</span><span class="s">"false"</span><span class="p">))</span>
   <span class="o">#(</span><span class="nv">address</span> <span class="p">()</span>
     <span class="p">(</span><span class="o">#(</span><span class="nv">address1</span> <span class="p">()</span> <span class="p">(</span><span class="s">"108 Main St."</span><span class="p">))</span>
      <span class="o">#(</span><span class="nv">address2</span> <span class="p">()</span> <span class="p">(</span><span class="s">"Apt #3"</span><span class="p">))</span>
      <span class="o">#(</span><span class="nv">city</span> <span class="p">()</span> <span class="p">(</span><span class="s">"Fairville"</span><span class="p">))</span>
      <span class="o">#(</span><span class="nv">state</span> <span class="p">()</span> <span class="p">(</span><span class="s">"WI"</span><span class="p">))</span>
      <span class="o">#(</span><span class="nv">zip</span> <span class="p">()</span> <span class="p">(</span><span class="s">"12345"</span><span class="p">))</span>
      <span class="o">#(</span><span class="nv">country</span> <span class="p">()</span> <span class="p">(</span><span class="s">"US"</span><span class="p">))</span>
      <span class="o">#(</span><span class="nv">phone</span> <span class="p">(</span><span class="o">#(</span><span class="no">nil</span> <span class="s">"nil"</span><span class="p">))</span> <span class="p">())))</span>
   <span class="o">#(</span><span class="nv">accept_language</span> <span class="p">(</span><span class="o">#(</span><span class="no">nil</span> <span class="s">"nil"</span><span class="p">))</span> <span class="p">())</span>
   <span class="o">#(</span><span class="nv">hosted_login_token</span> <span class="p">()</span> <span class="p">(</span><span class="s">"a92468579e9c4231a6c0031c4716c01d"</span><span class="p">))</span>
   <span class="o">#(</span><span class="nv">created_at</span> <span class="p">(</span><span class="o">#(</span><span class="k">type</span> <span class="s">"datetime"</span><span class="p">))</span> <span class="p">(</span><span class="s">"2011-10-25T12:00:00"</span><span class="p">))))</span>
</code></pre>

<p>As noted above, the format of the results depend upon what value you have passed
as the <code class="prettyprint">return-type</code>; by default, the <code class="prettyprint">data</code> type is passed and this simply
returns the data requested by the particular API call (not the headers, HTTP
status, body, XML conversion info, etc. &ndash; if you want that, you&rsquo;ll need to pass
the <code class="prettyprint">full</code> value associated with the <code class="prettyprint">return-type</code>).</p>

<p>The API calls return XML that has been parsed and converted to LFE data
structures by the <a href="https://github.com/willemdj/erlsom">erlsom</a> library.</p>

<p>The rcrly library offers a couple of convenience functions for extracting data
from this sort of structure &ndash; see the next two sections for more information
about data extraction.</p>

<h2 id="get-data"><code class="prettyprint">get-data</code></h2>

<blockquote>
<p>First, get some data using the <code class="prettyprint">full</code> return type:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">`#(</span><span class="nv">ok</span> <span class="o">,</span><span class="nv">results</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:get-accounts</span> <span class="o">`</span><span class="p">(</span><span class="o">#(</span><span class="nv">return-type</span> <span class="nv">full</span><span class="p">))))</span>
</code></pre>

<blockquote>
<p>Results:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="o">#(</span><span class="nv">ok</span>
  <span class="p">(</span><span class="o">#(</span><span class="nv">response</span> <span class="nv">ok</span><span class="p">)</span>
   <span class="o">#(</span><span class="nv">status</span> <span class="o">#(</span><span class="mi">200</span> <span class="s">"OK"</span><span class="p">))</span>
   <span class="o">#(</span><span class="nv">headers</span> <span class="p">(</span><span class="o">...</span><span class="p">))</span>
   <span class="o">#(</span><span class="nv">body</span>
     <span class="p">(</span><span class="o">#(</span><span class="nv">tag</span> <span class="s">"accounts"</span><span class="p">)</span>
      <span class="o">#(</span><span class="nv">attr</span> <span class="p">(</span><span class="o">#(</span><span class="k">type</span> <span class="s">"array"</span><span class="p">)))</span>
      <span class="o">#(</span><span class="nv">content</span>
        <span class="o">#(</span><span class="nv">accounts</span> <span class="o">...</span><span class="p">))))))</span>
</code></pre>

<blockquote>
<p>Example <code class="prettyprint">get-data</code> call:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get-data</span> <span class="nv">results</span><span class="p">)</span>
<span class="o">#(</span><span class="nv">accounts</span>
  <span class="p">(</span><span class="o">#(</span><span class="k">type</span> <span class="s">"array"</span><span class="p">))</span>
  <span class="p">(</span><span class="o">#(</span><span class="nv">account</span> <span class="o">...</span><span class="p">)</span>
   <span class="o">#(</span><span class="nv">account</span> <span class="o">...</span><span class="p">)))</span>
</code></pre>

<p>The <code class="prettyprint">get-data</code> utility function is provided in the <code class="prettyprint">rcrly</code> module and is
useful for extracing response data returned from client requests made with
the <code class="prettyprint">full</code> option. It assumes a nested property list structure with the
<code class="prettyprint">content</code> key in the <code class="prettyprint">body</code>&rsquo;s property list.</p>

<p>Though this is useful when dealing with response data from <code class="prettyprint">full</code> the return
type, you may find that it is more convenient to use the default <code class="prettyprint">data</code> return
type with the <code class="prettyprint">rcrly:get-in</code> function instead, as it allows you to extract
just the data you need. See below for an example.</p>

<h2 id="get-in"><code class="prettyprint">get-in</code></h2>

<blockquote>
<p>Get some data:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">`#(</span><span class="nv">ok</span> <span class="o">,</span><span class="nv">account</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:get-account</span> <span class="mi">1</span><span class="p">))</span>
</code></pre>

<blockquote>
<p>Results:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="o">#(</span><span class="nv">ok</span>
  <span class="o">#(</span><span class="nv">account</span>
    <span class="p">(</span><span class="o">#(</span><span class="nv">href</span> <span class="o">...</span><span class="p">))</span>
    <span class="p">(</span><span class="o">#(</span><span class="nv">adjustments</span> <span class="o">...</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="o">#(</span><span class="nv">address</span> <span class="p">()</span>
     <span class="p">(</span><span class="o">...</span>
      <span class="o">#(</span><span class="nv">city</span> <span class="p">()</span> <span class="p">(</span><span class="s">"Fairville"</span><span class="p">))</span>
      <span class="o">...</span><span class="p">))</span>
    <span class="o">...</span><span class="p">)))</span>
</code></pre>

<blockquote>
<p>Example <code class="prettyprint">get-in</code> call:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get-in</span> <span class="o">'</span><span class="p">(</span><span class="nv">account</span> <span class="nv">address</span> <span class="nv">city</span><span class="p">)</span> <span class="nv">account</span><span class="p">)</span>
<span class="s">"Fairville"</span>
</code></pre>

<blockquote>
<p>Note that the <code class="prettyprint">city</code> field is nested in the <code class="prettyprint">address</code> field. The <code class="prettyprint">address</code> data
is nested in the <code class="prettyprint">account</code>.</p>
</blockquote>

<p>The utillity function <code class="prettyprint">rcrly:get-in</code> is inspired by the Clojure <code class="prettyprint">get-in</code>
function, but in this case, tailored to work with the rcrly results which have
been converted from XML to LFE/Erlang data structures. With a single call, you
are able to retrieve data which is nested at any depth, providing just the keys
needed to locate it.</p>

<h2 id="get-linked"><code class="prettyprint">get-linked</code></h2>

<blockquote>
<p>Using the same account data as tthe last example, here&rsquo;s how you get the linked
transactions:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get-linked</span> <span class="o">'</span><span class="p">(</span><span class="nv">account</span> <span class="nv">transactions</span><span class="p">)</span> <span class="nv">account</span><span class="p">)</span>
<span class="o">#(</span><span class="nv">ok</span>
  <span class="o">#(</span><span class="nv">transactions</span>
    <span class="p">(</span><span class="o">#(</span><span class="k">type</span> <span class="s">"array"</span><span class="p">))</span>
    <span class="p">(</span><span class="o">#(</span><span class="nv">transaction</span> <span class="o">...</span><span class="p">)</span>
     <span class="o">#(</span><span class="nv">transaction</span> <span class="o">...</span><span class="p">)</span>
     <span class="o">#(</span><span class="nv">transaction</span> <span class="o">...</span><span class="p">)</span>
     <span class="o">...</span><span class="p">)))</span>
</code></pre>

<p>In the Recurly REST API, data relationships are encoded in media links, per
common best REST practices. Linked data may be retreived easily using the
<code class="prettyprint">get-linked/2</code> utility function (analog to the <code class="prettyprint">get-in/2</code> function).
<code class="prettyprint">get-linked/2</code> performs most of the same work that <code class="prettyprint">get-in/2</code> does, with
the exception being that the last item in the list of keys points to linked
data. As such, <code class="prettyprint">get-linked/2</code> will then perform an HTTP <code class="prettyprint">GET</code> for the
linked media.</p>

<h2 id="map-and-foldl"><code class="prettyprint">map</code> and <code class="prettyprint">foldl</code></h2>

<blockquote>
<p>Example <code class="prettyprint">map/2</code> call that lists all the plan names in the
system:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:map</span>
    <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">x</span><span class="p">)</span>
      <span class="p">(</span><span class="nv">rcrly:get-in</span> <span class="o">'</span><span class="p">(</span><span class="nv">plan</span> <span class="nv">name</span><span class="p">)</span> <span class="nv">x</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">rcrly:get-plans</span><span class="p">))</span>
</code></pre>

<blockquote>
<p>Results:</p>
</blockquote>
<pre class="highlight plaintext"><code>("Silver Plan" "Gold plan" "30-Day Free Trial")
</code></pre>

<blockquote>
<p>Example <code class="prettyprint">foldl/3</code> call that gets the total of all invoices
(ignoring currency type), starting with an &ldquo;add&rdquo; function:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">defun</span> <span class="nv">add-invoice</span> <span class="p">(</span><span class="nv">invoice</span> <span class="nv">subtotal</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">+</span> <span class="nv">subtotal</span>
      <span class="p">(</span><span class="nb">/</span> <span class="p">(</span><span class="nv">list_to_integer</span>
           <span class="p">(</span><span class="nv">rcrly:get-in</span> <span class="o">'</span><span class="p">(</span><span class="nv">invoice</span> <span class="nv">total_in_cents</span><span class="p">)</span> <span class="nv">invoice</span><span class="p">))</span>
         <span class="mi">100</span><span class="p">)))</span>
<span class="nv">add-invoice</span>
</code></pre>

<blockquote>
<p>Now to use that function with <code class="prettyprint">rcrly:foldl/3</code>:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:foldl</span>
    <span class="nf">#'</span><span class="nv">add-invoice/2</span>
    <span class="mi">0</span>
    <span class="p">(</span><span class="nv">rcrly:get-all-invoices</span><span class="p">))</span>
</code></pre>

<blockquote>
<p>Result:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="mf">120.03</span>
</code></pre>

<p>Recurly&rsquo;s API is XML-based, so parsed results have the following:
 * a tag
 * attributes
 * contents (which may itself contain nested tag/attrs/contents)</p>

<p>The <code class="prettyprint">map/2</code> and <code class="prettyprint">foldl/3</code> functions provided by rcrly aim to make working
with these results easier, especially for iterating through multi-valued
results.</p>

<p>It is important to note: <code class="prettyprint">map/2</code> and <code class="prettyprint">foldl/3</code> both take a <em>complete
result</em> &ndash; this inlcudes the <code class="prettyprint">#(ok ...)</code>.</p>

<h2 id="composing-results">Composing Results</h2>

<blockquote>
<p>To use the <code class="prettyprint">-&gt;&gt;</code> macro we&rsquo;ll need to slurp a file that has included it:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">slurp</span> <span class="s">"src/rcrly.lfe"</span><span class="p">)</span>
<span class="o">#(</span><span class="nv">ok</span> <span class="nv">rcrly</span><span class="p">)</span>
<span class="nb">&gt;</span>
</code></pre>

<blockquote>
<p>We&rsquo;re going to need some helper functions:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">defun</span> <span class="nv">get-xacts</span> <span class="p">(</span><span class="nv">acct</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">rcrly:get-linked</span> <span class="o">'</span><span class="p">(</span><span class="nv">account</span> <span class="nv">transactions</span><span class="p">)</span> <span class="nv">acct</span><span class="p">))</span>
<span class="nv">get-xacts</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nb">defun</span> <span class="nv">check-xacts</span> <span class="p">(</span><span class="nv">xacts</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">rcrly:map</span> <span class="nf">#'</span><span class="nv">check-xact/1</span> <span class="nv">xacts</span><span class="p">))</span>
<span class="nv">check-xacts</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nb">defun</span> <span class="nv">check-xact</span> <span class="p">(</span><span class="nv">xact</span><span class="p">)</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">=/=</span> <span class="p">(</span><span class="nv">rcrly:get-in</span> <span class="o">'</span><span class="p">(</span><span class="nv">transaction</span> <span class="nv">recurring</span><span class="p">)</span> <span class="nv">xact</span><span class="p">)</span> <span class="s">"true"</span><span class="p">)</span>
        <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">=:=</span> <span class="p">(</span><span class="nv">rcrly:get-in</span> <span class="o">'</span><span class="p">(</span><span class="nv">transaction</span> <span class="nv">status</span><span class="p">)</span> <span class="nv">xact</span><span class="p">)</span> <span class="s">"success"</span><span class="p">)</span>
            <span class="p">(</span><span class="nv">rcrly:get-in</span> <span class="o">'</span><span class="p">(</span><span class="nv">transaction</span> <span class="nv">uuid</span><span class="p">)</span> <span class="nv">xact</span><span class="p">))))</span>
<span class="nv">check-xact</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nb">defun</span> <span class="nv">id?</span>
    <span class="p">((</span><span class="nv">id</span><span class="p">)</span> <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">is_list</span> <span class="nv">id</span><span class="p">))</span>
     <span class="ss">'true</span><span class="p">)</span>
    <span class="p">((</span><span class="nv">x</span><span class="p">)</span> <span class="nv">x</span><span class="p">))</span>
<span class="nv">id?</span>
<span class="nb">&gt;</span>
</code></pre>

<blockquote>
<p>Now we can perform our defined task:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">-&gt;&gt;</span> <span class="p">(</span><span class="nv">rcrly:get-accounts</span><span class="p">)</span>        <span class="c1">; this returns a multi-valued result</span>
       <span class="p">(</span><span class="nv">rcrly:map</span> <span class="nf">#'</span><span class="nv">get-xacts/1</span><span class="p">)</span>   <span class="c1">; this returns a list of multi-valued results</span>
       <span class="p">(</span><span class="nv">lists:map</span> <span class="nf">#'</span><span class="nv">check-xacts/1</span><span class="p">)</span> <span class="c1">; this returns a list of lists</span>
       <span class="p">(</span><span class="nv">lists:foldl</span> <span class="nf">#'</span><span class="nv">++/2</span> <span class="o">'</span><span class="p">())</span>    <span class="c1">; this flattns the list, preserving strings</span>
       <span class="p">(</span><span class="nv">lists:filter</span> <span class="nf">#'</span><span class="nv">id?/1</span><span class="p">))</span>     <span class="c1">; just returns results that are ids</span>
</code></pre>

<blockquote>
<p>Results:</p>
</blockquote>
<pre class="highlight plaintext"><code>("2d9d1054c2716a3d38260146d28ebc7c"
 "2dc20791440f9313a877414fe1a6f7a4"
 "2dc2076ab55c2054cfaf3b427589437a"
 "2dbc6c2d09c5aed53a9ede41138f63df"
 "2dbc6c17524ca5cda869684a6bb7aae3")
</code></pre>

<blockquote>
<p>Of the 12 transactions in the accounts this was tested against, those five
satisfied the criteria of being non-recurring and in a successful state.</p>
</blockquote>

<p>This section might be more accurately called &ldquo;processing results through
function composition&rdquo; but that was a bit long. We hope you&rsquo;ll forgive the
poetic license we took!</p>

<p>With that said, here&rsquo;s an example of a potential &ldquo;data flow&rdquo; using function
composition to get the following:</p>

<ul>
<li>get a list of all the accounts</li>
<li>for each account, get all of its transactions</li>
<li>for each transaction, check to see that it&rsquo;s not recurring</li>
<li>return the transaction id for each recurring transation which has a &ldquo;success&rdquo; state</li>
</ul>

<aside class="success">
If you&rsquo;d like to use the &ldquo;->>&rdquo; macro in your own modules, be sure to include
it there with &ldquo;(include-lib &quot;lutil/include/compose.lfe&rdquo;)&ldquo;.
</aside>

<aside class="info">
Keep in mind that when using the &rdquo;->>&ldquo;
macro, the output of the first function is added as a final argument to the
next function.
</aside>

<aside class="info">
The example to the right is intended to show the possibilities of composition, and the following
should be noted about the above code:
<ul><li>by getting the accounts first, we could have performed additional checks
   against account data; and</li>
<li>if we had really wanted to check all the transactions without looking
   at any of the account data, we would have simply used the
   ``get-all-transactions&rdquo; rcrly API call.</li>
   </ul>
</aside>

<h2 id="batched-results-and-paging">Batched Results and Paging</h2>

<p>TBD</p>

<h2 id="relationships-and-linked-data">Relationships and Linked Data</h2>

<p>In the Recurly REST API, data relationships are encoded in media links, per
common best REST practices. Linked data may be retreived easily using the
<code class="prettyprint">get-linked/2</code> utility function (analog to the <code class="prettyprint">get-in/2</code> function).</p>

<p>For more information, see the <code class="prettyprint">get-linked</code> section above.</p>

          <h1 id="handling-errors">Handling Errors</h1>

<blockquote>
<p>The Recurly API will return errors under various circumstances. For instance,
an error is returned when attempting to look up billing information with a
non-existent account:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">`#(</span><span class="nb">error</span> <span class="o">,</span><span class="nb">error</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:get-billing-info</span> <span class="ss">'noaccountid</span><span class="p">))</span>
</code></pre>

<blockquote>
<p>Resulting error:</p>
</blockquote>
<pre class="highlight plaintext"><code>#(error
  #(error ()
    (#(symbol () ("not_found"))
     #(description
       (#(lang "en-US"))
       ("Couldn't find Account with account_code = noaccountid")))))
</code></pre>

<blockquote>
<p>Note that we pattern-matched against <code class="prettyprint">#(error ...)</code>. Also, you may use the <code class="prettyprint">get-in</code>
function to extract error information:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get-in</span> <span class="o">'</span><span class="p">(</span><span class="nb">error</span> <span class="nv">description</span><span class="p">)</span> <span class="nb">error</span><span class="p">)</span>
<span class="s">"Couldn't find Account with account_code = noaccountid"</span>
</code></pre>

<blockquote>
<p>Any HTTP request that generates an HTTP status code equal to or greater than
400 will be converted to an error. For example, requesting account information
with an id that no account has will generate a <code class="prettyprint">404 - Not Found</code> which will
be converted by rcrly to an application error:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">`#(</span><span class="nb">error</span> <span class="o">,</span><span class="nb">error</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:get-account</span> <span class="ss">'noaccountid</span><span class="p">))</span>
</code></pre>

<blockquote>
<p>Resulting error:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="o">#(</span><span class="nb">error</span>
  <span class="o">#(</span><span class="nb">error</span> <span class="p">()</span>
    <span class="p">(</span><span class="o">#(</span><span class="nc">symbol</span> <span class="p">()</span> <span class="p">(</span><span class="s">"not_found"</span><span class="p">))</span>
     <span class="o">#(</span><span class="nv">description</span>
       <span class="p">(</span><span class="o">#(</span><span class="nv">lang</span> <span class="s">"en-US"</span><span class="p">))</span>
       <span class="p">(</span><span class="s">"Couldn't find Account with account_code = noaccountid"</span><span class="p">)))))</span>
</code></pre>

<blockquote>
<p>Extracting the message:</p>
</blockquote>
<pre class="highlight plaintext"><code>&gt; (rcrly:get-in '(error description) error)
"Couldn't find Account with account_code = noaccountid"
</code></pre>

<blockquote>
<p>rcrly Errors: TBD</p>

<p>lhttpc Errors: TBD</p>
</blockquote>

<p>As mentioned in the &ldquo;Working with Results&rdquo; section, all parsed responses from
Recurly are a tuple of either <code class="prettyprint">#(ok ...)</code> or <code class="prettyprint">#(error ...)</code>. All processing
of rcrly results should pattern match against these typles, handling the error
cases as appropriate for the application using the rcrly library.</p>

<p>There are four types of errors that rcrly aims to address:</p>

<ul>
<li>Errors in the Recurly service (e.g., making a bad request that the service can&rsquo;t serve)</li>
<li>General HTTP errors</li>
<li>Errors in the rcrly library</li>
<li>Errors in the underlying lhttpc library</li>
</ul>

          <h1 id="logging">Logging</h1>

<p>rcrly uses the LFE logjam library for logging. The log level may be configured
in two places:</p>

<ul>
<li>an <code class="prettyprint">lfe.config</code> file (this is the standard location for logjam)</li>
<li>on a per-request basis in the <code class="prettyprint">options</code> arguement to API calls</li>
</ul>

<p>The default log level is <code class="prettyprint">emergency</code>, so you should never notice it&rsquo;s there
(unless, of course, you have lots ot logging defined for the <code class="prettyprint">emergency</code>
level &hellip;). The intended use for rcrly logging is on a per-request basis for
debugging purposes (though, of course, this may be easily overridden in your
application code by setting the log level you desire in the <code class="prettyprint">lfe.config</code>
file).</p>

<p>Note that when passing the <code class="prettyprint">log-level</code> option in an API call, it sets the
log level for the logging service which is running in the background. As such,
the <code class="prettyprint">log-level</code> option does not need to be passed again until you wish to
change it. In other words, when passed as an option, it is set for all future
API calls.</p>

<p>For more details on logging per-request, see the &ldquo;Options&rdquo; section above.</p>

          <h1 id="the-api">The API</h1>

<p>Each API call has a default arity and then an arity+1 where the &ldquo;+1&rdquo; is an
argument for rcrly client options (see the &ldquo;Options&rdquo; section above).</p>

<p>For each of the API functions listed below, be sure to examine the linked
Recurly documentation for information about payloads.</p>

<h2 id="accounts">Accounts</h2>

<p>Recurly <a href="https://docs.recurly.com/api/accounts">Accounts documentation</a></p>

<h3 id="get-accounts"><code class="prettyprint">get-accounts</code></h3>

<blockquote>
<p>Get all accounts:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">`#(</span><span class="nv">ok</span> <span class="o">,</span><span class="nv">accounts</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:get-accounts</span><span class="p">))</span>
</code></pre>

<blockquote>
<p>Results:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="o">#(</span><span class="nv">ok</span>
  <span class="p">(</span><span class="o">#(</span><span class="nv">account</span> <span class="o">...</span><span class="p">)</span>
   <span class="o">#(</span><span class="nv">account</span> <span class="o">...</span><span class="p">)))</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">accounts</span><span class="p">)</span>
<span class="mi">2</span>
</code></pre>

<p>Pages on all accounts in the system.</p>

<h3 id="get-account"><code class="prettyprint">get-account</code></h3>

<blockquote>
<p>Takes a single arguement and returns data for the account associated with
the provided id:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">`#(</span><span class="nv">ok</span> <span class="o">,</span><span class="nv">account</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:get-account</span> <span class="mi">1</span><span class="p">))</span>
</code></pre>

<blockquote>
<p>Results:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="o">#(</span><span class="nv">ok</span>
  <span class="o">#(</span><span class="nv">account</span>
    <span class="p">(</span><span class="o">#(</span><span class="nv">adjustments</span> <span class="o">...</span><span class="p">)</span>
     <span class="o">...</span><span class="p">)))</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get-in</span> <span class="o">'</span><span class="p">(</span><span class="nv">account</span> <span class="nv">state</span><span class="p">)</span> <span class="nv">account</span><span class="p">)</span>
<span class="s">"active"</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get-in</span> <span class="o">'</span><span class="p">(</span><span class="nv">account</span> <span class="nv">address</span> <span class="nv">city</span><span class="p">)</span> <span class="nv">account</span><span class="p">)</span>
<span class="s">"Fairville"</span>
</code></pre>

<p>Get a particular account by account ID.</p>

<h3 id="create-account"><code class="prettyprint">create-account</code></h3>

<blockquote>
<p>To use from the REPL, first, pull in the XML macros:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">slurp</span> <span class="s">"src/rcrly-xml.lfe"</span><span class="p">)</span>
<span class="o">#(</span><span class="nv">ok</span> <span class="nv">rcrly-xml</span><span class="p">)</span>
</code></pre>

<blockquote>
<p>Now create your payload:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="nv">payload</span>
    <span class="p">(</span><span class="nv">xml/account</span>
      <span class="p">(</span><span class="nb">list</span>
        <span class="p">(</span><span class="nv">xml/account_code</span> <span class="s">"123"</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">xml/email</span> <span class="s">"alice@example.com"</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">xml/first_name</span> <span class="s">"Alice"</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">xml/last_name</span> <span class="s">"Guthrie"</span><span class="p">))))</span>
</code></pre>

<blockquote>
<p>Which will give you:</p>
</blockquote>
<pre class="highlight xml"><code>"<span class="nt">&lt;account&gt;</span>...<span class="nt">&lt;/account&gt;</span>"
</code></pre>

<blockquote>
<p>Now make the API call to create the account:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">`#(</span><span class="nv">ok</span> <span class="o">,</span><span class="nv">account</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:create-account</span> <span class="nv">payload</span><span class="p">))</span>
<span class="o">#(</span><span class="nv">ok</span>
  <span class="o">#(</span><span class="nv">account</span> <span class="o">...</span><span class="p">))</span>
</code></pre>

<blockquote>
<p>With the account created, we can extract data from the results:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get-in</span> <span class="o">'</span><span class="p">(</span><span class="nv">account</span> <span class="nv">email</span><span class="p">)</span> <span class="nv">account</span><span class="p">)</span>
<span class="s">"alice@example.com"</span>
</code></pre>

<p>Create an account based upon provided payload data.</p>

<h3 id="update-account"><code class="prettyprint">update-account</code></h3>

<blockquote>
<p>Create your payload:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="nv">payload</span>
    <span class="p">(</span><span class="nv">xml/account</span>
        <span class="p">(</span><span class="nv">xml/company_name</span> <span class="s">"Alice's Hacker Cafe"</span><span class="p">)))</span>
<span class="s">"&lt;account&gt;...&lt;/account&gt;"</span>
</code></pre>

<blockquote>
<p>Now make the API call to update the account:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">`#(</span><span class="nv">ok</span> <span class="o">,</span><span class="nv">account</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:update-account</span> <span class="mi">123</span> <span class="nv">payload</span><span class="p">))</span>
<span class="o">#(</span><span class="nv">ok</span>
  <span class="o">#(</span><span class="nv">account</span> <span class="o">...</span><span class="p">))</span>
</code></pre>

<blockquote>
<p>With the account updated, we can extract data from the results:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get-in</span> <span class="o">'</span><span class="p">(</span><span class="nv">account</span> <span class="nv">email</span><span class="p">)</span> <span class="nv">account</span><span class="p">)</span>
<span class="s">"alice@example.com"</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get-in</span> <span class="o">'</span><span class="p">(</span><span class="nv">account</span> <span class="nv">company_name</span><span class="p">)</span> <span class="nv">account</span><span class="p">)</span>
<span class="s">"Alice's Hacker Cafe"</span>
</code></pre>

<p>This function takes account id and payload data.</p>

<h3 id="close-account"><code class="prettyprint">close-account</code></h3>

<blockquote>
<p>Close an account:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">`#(</span><span class="nv">ok</span> <span class="s">""</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:close-account</span> <span class="mi">123</span><span class="p">))</span>
<span class="o">#(</span><span class="nv">ok</span> <span class="p">())</span>
</code></pre>

<p>Takes an account id.</p>

<h3 id="reopen-account"><code class="prettyprint">reopen-account</code></h3>

<blockquote>
<p>Re-open an account that had been closed:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">`#(</span><span class="nv">ok</span> <span class="o">,</span><span class="nv">account</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:reopen-account</span> <span class="mi">123</span><span class="p">))</span>
<span class="o">#(</span><span class="nv">ok</span>
  <span class="o">#(</span><span class="nv">account</span> <span class="o">...</span><span class="p">))</span>
</code></pre>

<p>Takes an account id.</p>

<h2 id="adjustments">Adjustments</h2>

<p>Recurly <a href="https://docs.recurly.com/api/adjustments">Adjustments documentation</a></p>

<h3 id="get-adjustments"><code class="prettyprint">get-adjustments</code></h3>

<blockquote>
<p>Get all adjustments:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">`#(</span><span class="nv">ok</span> <span class="o">,</span><span class="nv">adjustments</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:get-adjustments</span> <span class="mi">1</span><span class="p">))</span>
</code></pre>

<blockquote>
<p>Results:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="o">#(</span><span class="nv">ok</span>
  <span class="o">#(</span><span class="nv">adjustments</span>
    <span class="p">(</span><span class="o">#(</span><span class="k">type</span> <span class="s">"array"</span><span class="p">))</span>
    <span class="p">(</span><span class="o">#(</span><span class="nv">adjustment</span> <span class="o">...</span><span class="p">)</span>
     <span class="o">#(</span><span class="nv">adjustment</span> <span class="o">...</span><span class="p">)</span>
     <span class="o">...</span><span class="p">)))</span>
</code></pre>

<p>Takes an account id.</p>

<h3 id="get-adjustment"><code class="prettyprint">get-adjustment</code></h3>

<blockquote>
<p>Get a particular adjustment:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">`#(</span><span class="nv">ok</span> <span class="o">,</span><span class="nv">adjustment</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:get-adjustment</span> <span class="s">"2d97cfa52e80a675a532ba4e8ea25401"</span><span class="p">))</span>
</code></pre>

<blockquote>
<p>Results:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="o">#(</span><span class="nv">ok</span>
  <span class="o">#(</span><span class="nv">adjustment</span>
    <span class="p">(</span><span class="o">#(</span><span class="k">type</span> <span class="s">"credit"</span><span class="p">)</span>
     <span class="o">#(</span><span class="nv">href</span>
       <span class="s">"https://yourname.recurly.com/v2/adjustments/2d97cf12a5...."</span><span class="p">))</span>
    <span class="p">(</span><span class="o">#(</span><span class="nv">account</span> <span class="p">(</span><span class="o">#(</span><span class="nv">href</span> <span class="s">"https://yourname.recurly.com/v2/accounts/1"</span><span class="p">))</span> <span class="p">())</span>
     <span class="o">#(</span><span class="nv">uuid</span> <span class="p">()</span> <span class="p">(</span><span class="s">"2d97cfa52e80a675a532ba4e8ea25401"</span><span class="p">))</span>
     <span class="o">#(</span><span class="nv">state</span> <span class="p">()</span> <span class="p">(</span><span class="s">"pending"</span><span class="p">))</span>
     <span class="o">...</span>
     <span class="o">#(</span><span class="nv">origin</span> <span class="p">()</span> <span class="p">(</span><span class="s">"credit"</span><span class="p">))</span>
     <span class="o">...</span>
     <span class="o">#(</span><span class="nv">total_in_cents</span> <span class="p">(</span><span class="o">#(</span><span class="k">type</span> <span class="s">"integer"</span><span class="p">))</span> <span class="p">(</span><span class="s">"-100"</span><span class="p">))</span>
     <span class="o">#(</span><span class="nv">currency</span> <span class="p">()</span> <span class="p">(</span><span class="s">"USD"</span><span class="p">))</span>
     <span class="o">#(</span><span class="nv">taxable</span> <span class="p">(</span><span class="o">#(</span><span class="k">type</span> <span class="s">"boolean"</span><span class="p">))</span> <span class="p">(</span><span class="s">"false"</span><span class="p">))</span>
     <span class="o">#(</span><span class="nv">start_date</span> <span class="p">(</span><span class="o">#(</span><span class="k">type</span> <span class="s">"datetime"</span><span class="p">))</span> <span class="p">(</span><span class="s">"2015-03-17T18:34:56Z"</span><span class="p">))</span>
     <span class="o">#(</span><span class="nv">end_date</span> <span class="p">(</span><span class="o">#(</span><span class="no">nil</span> <span class="s">"nil"</span><span class="p">))</span> <span class="p">())</span>
     <span class="o">#(</span><span class="nv">created_at</span> <span class="p">(</span><span class="o">#(</span><span class="k">type</span> <span class="s">"datetime"</span><span class="p">))</span> <span class="p">(</span><span class="s">"2015-03-17T18:34:56Z"</span><span class="p">)))))</span>
</code></pre>

<blockquote>
<p>Now you can do the usual things:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get-in</span> <span class="o">'</span><span class="p">(</span><span class="nv">adjustment</span> <span class="nv">total_in_cents</span><span class="p">)</span> <span class="nv">adjustment</span><span class="p">)</span>
<span class="s">"-100"</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get-in</span> <span class="o">'</span><span class="p">(</span><span class="nv">adjustment</span> <span class="nv">state</span><span class="p">)</span> <span class="nv">adjustment</span><span class="p">)</span>
<span class="s">"pending"</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get-in</span> <span class="o">'</span><span class="p">(</span><span class="nv">adjustment</span> <span class="nv">origin</span><span class="p">)</span> <span class="nv">adjustment</span><span class="p">)</span>
<span class="s">"credit"</span>
</code></pre>

<p>Takes a UUID.</p>

<h2 id="billing-info">Billing Info</h2>

<p>Recurly <a href="https://docs.recurly.com/api/billing-info">Billing Info documentation</a></p>

<h3 id="get-billing-info"><code class="prettyprint">get-billing-info</code></h3>

<blockquote>
<p>Get billing info for a particular account:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">`#(</span><span class="nv">ok</span> <span class="o">,</span><span class="nv">info</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:get-billing-info</span> <span class="mi">1</span><span class="p">))</span>
</code></pre>

<blockquote>
<p>Results:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="o">#(</span><span class="nv">ok</span>
  <span class="o">#(</span><span class="nv">billing_info</span>
    <span class="p">(</span><span class="o">#(</span><span class="k">type</span> <span class="s">"credit_card"</span><span class="p">)</span>
     <span class="o">#(</span><span class="nv">href</span> <span class="s">"https://yourname.recurly.com/v2/accounts/1/billing_info"</span><span class="p">))</span>
    <span class="p">(</span><span class="o">#(</span><span class="nv">account</span> <span class="p">(</span><span class="o">#(</span><span class="nv">href</span> <span class="s">"https://yourname.recurly.com/v2/accounts/1"</span><span class="p">))</span> <span class="p">())</span>
     <span class="o">...</span>
     <span class="o">#(</span><span class="nv">company</span> <span class="p">(</span><span class="o">#(</span><span class="no">nil</span> <span class="s">"nil"</span><span class="p">))</span> <span class="p">())</span>
     <span class="o">#(</span><span class="nv">address1</span> <span class="p">()</span> <span class="p">(</span><span class="s">"108 Main St"</span><span class="p">))</span>
     <span class="o">...</span>
     <span class="o">#(</span><span class="nv">city</span> <span class="p">()</span> <span class="p">(</span><span class="s">"Fairville"</span><span class="p">))</span>
     <span class="o">#(</span><span class="nv">state</span> <span class="p">()</span> <span class="p">(</span><span class="s">"WI"</span><span class="p">))</span>
     <span class="o">#(</span><span class="nv">zip</span> <span class="p">()</span> <span class="p">(</span><span class="s">"12345"</span><span class="p">))</span>
     <span class="o">...</span>
     <span class="o">#(</span><span class="nv">card_type</span> <span class="p">()</span> <span class="p">(</span><span class="s">"Visa"</span><span class="p">))</span>
     <span class="o">#(</span><span class="nv">year</span> <span class="p">(</span><span class="o">#(</span><span class="k">type</span> <span class="s">"integer"</span><span class="p">))</span> <span class="p">(</span><span class="s">"2016"</span><span class="p">))</span>
     <span class="o">#(</span><span class="nv">month</span> <span class="p">(</span><span class="o">#(</span><span class="k">type</span> <span class="s">"integer"</span><span class="p">))</span> <span class="p">(</span><span class="s">"3"</span><span class="p">))</span>
     <span class="o">...</span><span class="p">)))</span>
</code></pre>

<blockquote>
<p>Extract some data:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get-in</span> <span class="o">'</span><span class="p">(</span><span class="nv">billing_info</span> <span class="nv">card_type</span><span class="p">)</span> <span class="nv">info</span><span class="p">)</span>
<span class="s">"Visa"</span>
</code></pre>

<p>Takes an account id.</p>

<h3 id="update-billing-info"><code class="prettyprint">update-billing-info</code></h3>

<p>To update billing info from the REPL, first pull in the XML macros:</p>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">slurp</span> <span class="s">"src/rcrly-xml.lfe"</span><span class="p">)</span>
<span class="o">#(</span><span class="nv">ok</span> <span class="nv">rcrly-xml</span><span class="p">)</span>
</code></pre>

<blockquote>
<p>Now set some argument values (helps to keep things more readable):</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="nv">account-id</span> <span class="mi">1</span><span class="p">)</span>
<span class="mi">1</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="nv">payload</span>
    <span class="p">(</span><span class="nv">xml/billing_info</span>
        <span class="p">(</span><span class="nb">list</span> <span class="p">(</span><span class="nv">xml/first_name</span> <span class="s">"Verena"</span><span class="p">)</span>
              <span class="p">(</span><span class="nv">xml/last_name</span> <span class="s">"Example"</span><span class="p">))))</span>
<span class="s">"&lt;billing_info&gt; ... &lt;/billing_info&gt;"</span>
</code></pre>

<blockquote>
<p>With those in place, you can made your API call to update the billing
info:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">`#(</span><span class="nv">ok</span> <span class="o">,</span><span class="nv">info</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:update-billing-info</span> <span class="nv">account-id</span> <span class="nv">payload</span><span class="p">))</span>
</code></pre>

<blockquote>
<p>Results:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="o">#(</span><span class="nv">ok</span>
  <span class="o">#(</span><span class="nv">billing_info</span>
    <span class="p">(</span><span class="o">#(</span><span class="k">type</span> <span class="s">"credit_card"</span><span class="p">)</span>
     <span class="o">#(</span><span class="nv">href</span> <span class="s">"https://yourname.recurly.com/v2/accounts/1/billing_info"</span><span class="p">))</span>
    <span class="p">(</span><span class="o">#(</span><span class="nv">account</span> <span class="p">(</span><span class="o">#(</span><span class="nv">href</span> <span class="s">"https://yourname.recurly.com/v2/accounts/1"</span><span class="p">))</span> <span class="p">())</span>
     <span class="o">...</span>
     <span class="o">#(</span><span class="nv">company</span> <span class="p">(</span><span class="o">#(</span><span class="no">nil</span> <span class="s">"nil"</span><span class="p">))</span> <span class="p">())</span>
     <span class="o">#(</span><span class="nv">address1</span> <span class="p">()</span> <span class="p">(</span><span class="s">"108 Main St"</span><span class="p">))</span>
     <span class="o">...</span>
     <span class="o">#(</span><span class="nv">city</span> <span class="p">()</span> <span class="p">(</span><span class="s">"Fairville"</span><span class="p">))</span>
     <span class="o">#(</span><span class="nv">state</span> <span class="p">()</span> <span class="p">(</span><span class="s">"WI"</span><span class="p">))</span>
     <span class="o">#(</span><span class="nv">zip</span> <span class="p">()</span> <span class="p">(</span><span class="s">"12345"</span><span class="p">))</span>
     <span class="o">...</span>
     <span class="o">#(</span><span class="nv">card_type</span> <span class="p">()</span> <span class="p">(</span><span class="s">"Visa"</span><span class="p">))</span>
     <span class="o">#(</span><span class="nv">year</span> <span class="p">(</span><span class="o">#(</span><span class="k">type</span> <span class="s">"integer"</span><span class="p">))</span> <span class="p">(</span><span class="s">"2016"</span><span class="p">))</span>
     <span class="o">#(</span><span class="nv">month</span> <span class="p">(</span><span class="o">#(</span><span class="k">type</span> <span class="s">"integer"</span><span class="p">))</span> <span class="p">(</span><span class="s">"3"</span><span class="p">))</span>
     <span class="o">...</span><span class="p">)))</span>
</code></pre>

<blockquote>
<p>We can easily confirm that our results have the updated data:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get-in</span> <span class="o">'</span><span class="p">(</span><span class="nv">billing_info</span> <span class="nv">first_name</span><span class="p">)</span> <span class="nv">info</span><span class="p">)</span>
<span class="s">"Verena"</span>
</code></pre>

<p>Takes payload data.</p>

<h3 id="clear-billing-info"><code class="prettyprint">clear-billing-info</code></h3>

<p>TBD</p>

<h2 id="invoices">Invoices</h2>

<p>Recurly <a href="https://docs.recurly.com/api/invoices">Invoices documentation</a></p>

<h3 id="get-all-invoices"><code class="prettyprint">get-all-invoices</code></h3>

<blockquote>
<p>Get all the invoices for all accounts:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">`#(</span><span class="nv">ok</span> <span class="o">,</span><span class="nv">invoices</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:get-all-invoices</span><span class="p">))</span>
<span class="o">#(</span><span class="nv">ok</span>
  <span class="o">#(</span><span class="nv">invoices</span> <span class="o">...</span><span class="p">))</span>
</code></pre>

<p>Takes no arguments.</p>

<h3 id="get-invoices"><code class="prettyprint">get-invoices</code></h3>

<blockquote>
<p>Get all the invoices for one account:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">`#(</span><span class="nv">ok</span> <span class="o">,</span><span class="nv">invoices</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:get-invoices</span> <span class="mi">123</span><span class="p">))</span>
</code></pre>

<blockquote>
<p>Results:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="o">#(</span><span class="nv">ok</span>
  <span class="o">#(</span><span class="nv">invoices</span> <span class="o">...</span><span class="p">))</span>
</code></pre>

<p>Takes an account id.</p>

<h3 id="get-invoice"><code class="prettyprint">get-invoice</code></h3>

<blockquote>
<p>Get a particular invoice:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">`#(</span><span class="nv">ok</span> <span class="o">,</span><span class="nv">invoice</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:get-invoice</span> <span class="mi">1402</span><span class="p">))</span>
</code></pre>

<p>Result has the follwoing form:</p>
<pre class="highlight common_lisp"><code><span class="o">#(</span><span class="nv">ok</span>
  <span class="o">#(</span><span class="nv">invoice</span> <span class="o">...</span><span class="p">))</span>
</code></pre>

<p>Takes an invoice number:</p>

<h3 id="get-invoice-pdf"><code class="prettyprint">get-invoice-pdf</code></h3>

<p>TBD</p>

<h3 id="preview-invoice"><code class="prettyprint">preview-invoice</code></h3>

<p>TBD</p>

<h3 id="invoice"><code class="prettyprint">invoice</code></h3>

<p>TBD</p>

<h3 id="set-paid-invoice"><code class="prettyprint">set-paid-invoice</code></h3>

<p>TBD</p>

<h3 id="set-failed-invoice"><code class="prettyprint">set-failed-invoice</code></h3>

<p>TBD</p>

<h3 id="set-line-refund-invoice"><code class="prettyprint">set-line-refund-invoice</code></h3>

<p>TBD</p>

<h3 id="set-open-refund-invoice"><code class="prettyprint">set-open-refund-invoice</code></h3>

<p>TBD</p>

<h2 id="plans">Plans</h2>

<p>Recurly <a href="https://docs.recurly.com/api/plans">Invoices documentation</a></p>

<h3 id="get-plans"><code class="prettyprint">get-plans</code></h3>

<blockquote>
<p>Get all plans:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">`#(</span><span class="nv">ok</span> <span class="o">,</span><span class="nv">plans</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:get-plans</span><span class="p">))</span>
</code></pre>

<blockquote>
<p>Results:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="o">#(</span><span class="nv">ok</span>
  <span class="o">#(</span><span class="nv">plans</span>
    <span class="p">(</span><span class="o">#(</span><span class="k">type</span> <span class="s">"array"</span><span class="p">))</span>
    <span class="p">(</span><span class="o">#(</span><span class="nv">plan</span> <span class="o">...</span><span class="p">))))</span>
</code></pre>

<p>Takes no arguments.</p>

<h3 id="get-plan"><code class="prettyprint">get-plan</code></h3>

<blockquote>
<p>Get a specific plan:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">`#(</span><span class="nv">ok</span> <span class="o">,</span><span class="nv">plan</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:get-plan</span> <span class="mi">1402</span><span class="p">))</span>
<span class="o">#(</span><span class="nv">ok</span>
  <span class="o">#(</span><span class="nv">plan</span> <span class="o">...</span><span class="p">))</span>
</code></pre>

<blockquote>
<p>Extract the plan name:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get-in</span> <span class="o">'</span><span class="p">(</span><span class="nv">plan</span> <span class="nv">name</span><span class="p">)</span> <span class="nv">plan</span><span class="p">)</span>
<span class="s">"30-Day Free Trial"</span>
</code></pre>

<p>Takes a plan code.</p>

<h3 id="create-plan"><code class="prettyprint">create-plan</code></h3>

<blockquote>
<p>Create your payload:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="nv">payload</span>
    <span class="p">(</span><span class="nv">xml/plan</span>
      <span class="p">(</span><span class="nb">list</span>
        <span class="p">(</span><span class="nv">xml/plan_code</span> <span class="s">"gold"</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">xml/name</span> <span class="s">"Gold plan"</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">xml/setup_fee_in_cents</span>
          <span class="p">(</span><span class="nb">list</span>
            <span class="p">(</span><span class="nv">xml/USD</span> <span class="s">"1000"</span><span class="p">)</span>
            <span class="p">(</span><span class="nv">xml/EUR</span> <span class="s">"800"</span><span class="p">)))</span>
        <span class="p">(</span><span class="nv">xml/unit_amount_in_cents</span>
          <span class="p">(</span><span class="nb">list</span>
            <span class="p">(</span><span class="nv">xml/USD</span> <span class="s">"6000"</span><span class="p">)</span>
            <span class="p">(</span><span class="nv">xml/EUR</span> <span class="s">"4500"</span><span class="p">)))</span>
        <span class="p">(</span><span class="nv">xml/plan_interval_length</span> <span class="s">"1"</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">xml/plan_interval_unit</span> <span class="s">"months"</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">xml/tax_exempt</span> <span class="s">"false"</span><span class="p">))))</span>
</code></pre>
<pre class="highlight xml"><code>"<span class="nt">&lt;plan&gt;</span>...<span class="nt">&lt;/plan&gt;</span>"
</code></pre>

<blockquote>
<p>Now make the API call to create the plan:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">`#(</span><span class="nv">ok</span> <span class="o">,</span><span class="nv">plan</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:create-plan</span> <span class="nv">payload</span><span class="p">))</span>
<span class="o">#(</span><span class="nv">ok</span>
  <span class="o">#(</span><span class="nv">plan</span> <span class="o">...</span><span class="p">))</span>
</code></pre>

<blockquote>
<p>With the plan created, we can extract data from the results:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get-in</span> <span class="o">'</span><span class="p">(</span><span class="nv">plan</span> <span class="nv">setup_fee_in_cents</span> <span class="nv">EUR</span><span class="p">)</span> <span class="nv">plan</span><span class="p">)</span>
<span class="s">"4500"</span>
</code></pre>

<p>Takes payload data.</p>

<h3 id="update-plan"><code class="prettyprint">update-plan</code></h3>

<p>TBD</p>

<h3 id="delete-plan"><code class="prettyprint">delete-plan</code></h3>

<blockquote>
<p>To delete a plan, simply pass the plan code to <code class="prettyprint">delete-plan</code>:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">`#(</span><span class="nv">ok</span> <span class="o">,</span><span class="nv">results</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:delete-plan</span> <span class="s">"gold"</span><span class="p">))</span>
<span class="nv">[response</span> <span class="nv">TBD]</span>
</code></pre>

<h2 id="subscriptions">Subscriptions</h2>

<p>Recurly <a href="https://docs.recurly.com/api/subscriptions">InvoicesSubscriptions documentation</a></p>

<h3 id="get-all-subscriptions"><code class="prettyprint">get-all-subscriptions</code></h3>

<blockquote>
<p>Get all subscriptions:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">`#(</span><span class="nv">ok</span> <span class="o">,</span><span class="nv">subs</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:get-all-subscriptions</span> <span class="o">'</span><span class="p">()))</span>
<span class="o">#(</span><span class="nv">ok</span>
  <span class="o">#(</span><span class="nv">subscriptions</span>
    <span class="p">(</span><span class="o">#(</span><span class="k">type</span> <span class="s">"array"</span><span class="p">))</span>
    <span class="p">(</span><span class="o">#(</span><span class="nv">subscription</span> <span class="o">...</span><span class="p">))))</span>
</code></pre>

<p>Takes no arguments.</p>

<h3 id="get-subscriptions"><code class="prettyprint">get-subscriptions</code></h3>

<blockquote>
<p>Get all subscriptions for an account:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">`#(</span><span class="nv">ok</span> <span class="o">,</span><span class="nv">subs</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:get-subscriptions</span> <span class="mi">123</span><span class="p">))</span>
<span class="o">#(</span><span class="nv">ok</span>
  <span class="o">#(</span><span class="nv">subscriptions</span>
    <span class="p">(</span><span class="o">#(</span><span class="k">type</span> <span class="s">"array"</span><span class="p">))</span>
    <span class="p">(</span><span class="o">#(</span><span class="nv">subscription</span> <span class="o">...</span><span class="p">))))</span>
</code></pre>

<p>Takes an account id:</p>

<h3 id="get-subscription"><code class="prettyprint">get-subscription</code></h3>

<blockquote>
<p>Get a particular subscription:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="nv">uuid</span> <span class="s">"2dbc6c2cb823174353853a409c90d419"</span><span class="p">)</span>
<span class="s">"2dbc6c2cb823174353853a409c90d419"</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">`#(</span><span class="nv">ok</span> <span class="o">,</span><span class="nv">subs</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:get-subscription</span> <span class="nv">uuid</span><span class="p">))</span>
<span class="o">#(</span><span class="nv">ok</span>
  <span class="o">#(</span><span class="nv">subscription</span> <span class="o">...</span><span class="p">))</span>
</code></pre>

<blockquote>
<p>Extract data as needed:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get-in</span> <span class="o">'</span><span class="p">(</span><span class="nv">subscription</span> <span class="nv">current_period_started_at</span><span class="p">)</span> <span class="nv">subs</span><span class="p">)</span>
<span class="s">"2015-03-24T21:12:14Z"</span>
</code></pre>

<p>Takes a subscription UUID:</p>

<h3 id="create-subscription"><code class="prettyprint">create-subscription</code></h3>

<blockquote>
<p>To create a subscription, first create your payload:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="nv">payload</span>
    <span class="p">(</span><span class="nv">xml/subscription</span>
      <span class="p">(</span><span class="nb">list</span>
        <span class="p">(</span><span class="nv">xml/plan_code</span> <span class="s">"gold"</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">xml/currency</span> <span class="s">"USD"</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">xml/account</span>
          <span class="p">(</span><span class="nv">xml/account_code</span> <span class="s">"123"</span><span class="p">)))))</span>
</code></pre>
<pre class="highlight xml"><code>"<span class="nt">&lt;subscription&gt;</span>...<span class="nt">&lt;/subscription&gt;</span>"
</code></pre>

<blockquote>
<p>Now make the API call to create the plan:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">`#(</span><span class="nv">ok</span> <span class="o">,</span><span class="nv">subs</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:create-subscription</span> <span class="nv">payload</span><span class="p">))</span>
<span class="o">#(</span><span class="nv">ok</span>
  <span class="o">#(</span><span class="nv">subscription</span> <span class="o">...</span><span class="p">))</span>
</code></pre>

<blockquote>
<p>With the plan created, we can extract data from the results:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get-in</span> <span class="o">'</span><span class="p">(</span><span class="nv">subscription</span> <span class="nv">plan</span> <span class="nv">name</span><span class="p">)</span> <span class="nv">subs</span><span class="p">)</span>
<span class="s">"Gold plan"</span>
</code></pre>

<p>Takes payload data.</p>

<h3 id="preview-subscription"><code class="prettyprint">preview-subscription</code></h3>

<p>TBD</p>

<h3 id="update-subscription"><code class="prettyprint">update-subscription</code></h3>

<blockquote>
<p>To update a subscription, create your payload:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="nv">uuid</span> <span class="s">"2dbc6c2cb823174353853a409c90d419"</span><span class="p">)</span>
<span class="s">"2dbc6c2cb823174353853a409c90d419"</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="nv">payload</span>
    <span class="p">(</span><span class="nv">xml/subscription</span>
      <span class="p">(</span><span class="nb">list</span>
        <span class="p">(</span><span class="nv">xml/timeframe</span> <span class="s">"now"</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">xml/plan_code</span> <span class="s">"silver"</span><span class="p">))))</span>
<span class="s">"&lt;subscription&gt;...&lt;/subscription&gt;"</span>
</code></pre>

<blockquote>
<p>Now make the API call to create the plan:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">`#(</span><span class="nv">ok</span> <span class="o">,</span><span class="nv">subs</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:update-subscription</span> <span class="nv">uuid</span> <span class="nv">payload</span><span class="p">))</span>
<span class="o">#(</span><span class="nv">ok</span>
  <span class="o">#(</span><span class="nv">subscription</span> <span class="o">...</span><span class="p">))</span>
</code></pre>

<blockquote>
<p>With the plan created, we can extract data from the results:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get-in</span> <span class="o">'</span><span class="p">(</span><span class="nv">subscription</span> <span class="nv">plan</span> <span class="nv">name</span><span class="p">)</span> <span class="nv">subs</span><span class="p">)</span>
<span class="s">"Silver plan"</span>
</code></pre>

<p>Takes subscription UUID and payload data.</p>

<h3 id="update-subscription-notes"><code class="prettyprint">update-subscription-notes</code></h3>

<p>TBD</p>

<h3 id="cancel-subscription"><code class="prettyprint">cancel-subscription</code></h3>

<blockquote>
<p>To cancel a subscription:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="nv">uuid</span> <span class="s">"2dbc6c2cb823174353853a409c90d419"</span><span class="p">)</span>
<span class="s">"2dbc6c2cb823174353853a409c90d419"</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">#(</span><span class="nv">ok</span> <span class="o">,</span><span class="nv">subs</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:cancel-subscription</span> <span class="nv">uuid</span><span class="p">))</span>
<span class="o">#(</span><span class="nv">ok</span>
  <span class="o">#(</span><span class="nv">subscription</span> <span class="o">...</span><span class="p">))</span>
</code></pre>

<blockquote>
<p>And you can check the subscription state:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get-in</span> <span class="o">'</span><span class="p">(</span><span class="nv">subscription</span> <span class="nv">state</span><span class="p">)</span> <span class="nv">subs</span><span class="p">)</span>
<span class="s">"canceled"</span>
</code></pre>

<p>Takes a subscription UUID.</p>

<h3 id="reactivate-subscription"><code class="prettyprint">reactivate-subscription</code></h3>

<blockquote>
<p>To reactivate a subscription:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="nv">uuid</span> <span class="s">"2dbc6c2cb823174353853a409c90d419"</span><span class="p">)</span>
<span class="s">"2dbc6c2cb823174353853a409c90d419"</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">#(</span><span class="nv">ok</span> <span class="o">,</span><span class="nv">subs</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:reactivate-subscription</span> <span class="nv">uuid</span><span class="p">))</span>
<span class="o">#(</span><span class="nv">ok</span>
  <span class="o">#(</span><span class="nv">subscription</span> <span class="o">...</span><span class="p">))</span>
</code></pre>

<blockquote>
<p>Check the subscription state:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get-in</span> <span class="o">'</span><span class="p">(</span><span class="nv">subscription</span> <span class="nv">state</span><span class="p">)</span> <span class="nv">subs</span><span class="p">)</span>
<span class="s">"active"</span>
</code></pre>

<p>Takes a subscription UUID</p>

<h3 id="terminate-subscription"><code class="prettyprint">terminate-subscription</code></h3>

<p>To terminate a subscription:</p>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="nv">uuid</span> <span class="s">"2dbc6c2cb823174353853a409c90d419"</span><span class="p">)</span>
<span class="s">"2dbc6c2cb823174353853a409c90d419"</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="o">#(</span><span class="nv">ok</span> <span class="o">,</span><span class="nv">subs</span><span class="p">)</span> <span class="p">(</span><span class="nv">rcrly:terminate-subscription</span> <span class="nv">uuid</span><span class="p">))</span>
<span class="o">#(</span><span class="nv">ok</span>
  <span class="o">#(</span><span class="nv">subscription</span> <span class="o">...</span><span class="p">))</span>
</code></pre>

<blockquote>
<p>Check the subscription state:</p>
</blockquote>
<pre class="highlight common_lisp"><code><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">rcrly:get-in</span> <span class="o">'</span><span class="p">(</span><span class="nv">subscription</span> <span class="nv">statue</span><span class="p">)</span> <span class="nv">subs</span><span class="p">)</span>
<span class="s">"expired"</span>
</code></pre>

<p>Takes a subscription UUID</p>

<h3 id="postpone-subscription"><code class="prettyprint">postpone-subscription</code></h3>

<h2 id="transactions">Transactions</h2>

<p>Recurly <a href="https://docs.recurly.com/api/transactions">Transactions documentation</a></p>

<h3 id="get-all-transactions"><code class="prettyprint">get-all-transactions</code></h3>

<p>TBD</p>

<h3 id="get-transactions"><code class="prettyprint">get-transactions</code></h3>

<p>TBD</p>

      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name=""></a>
          </div>
      </div>
    </div>
  </body>
</html>
